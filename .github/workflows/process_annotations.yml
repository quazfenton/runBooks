name: Process Runbook Annotations

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      incident_id:
        description: 'Incident ID (e.g., INC-123)'
        required: true
        type: string
      cause:
        description: 'Root cause of the incident'
        required: true
        type: string
      fix:
        description: 'Fix applied to resolve the incident'
        required: true
        type: string
      runbook_path:
        description: 'Path to the runbook file'
        required: false
        default: 'runbooks/service-x/runbook.yaml'
        type: string

jobs:
  process-annotation-comment:
    if: ${{ github.event_name == 'issue_comment' && (contains(github.event.comment.body, '/annotate') || contains(github.event.comment.body, '/runbook-update')) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Parse annotation command
        id: parse
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Extract annotation details from the comment
          COMMENT="$COMMENT_BODY"

          # Example format: /annotate INC-123 --cause "Memory leak" --fix "Increased limits"
          # Use safer pattern matching to avoid shell injection
          REGEX_PATTERN='/annotate[[:space:]]+([A-Z0-9-]+)[[:space:]]+--cause[[:space:]]+"([^"]+)"[[:space:]]+--fix[[:space:]]+"([^"]+)"'
          if [[ "$COMMENT" =~ $REGEX_PATTERN ]]; then
            # Sanitize extracted values to prevent injection
            INCIDENT_ID="${BASH_REMATCH[1]//[^A-Z0-9-]/}"
            CAUSE="$(printf '%s' "${BASH_REMATCH[2]}" | sed 's/[^a-zA-Z0-9 _.-]//g')"
            FIX="$(printf '%s' "${BASH_REMATCH[3]}" | sed 's/[^a-zA-Z0-9 _.-]//g')"

            echo "incident_id=$INCIDENT_ID" >> $GITHUB_OUTPUT
            echo "cause=$CAUSE" >> $GITHUB_OUTPUT
            echo "fix=$FIX" >> $GITHUB_OUTPUT

            # Extract runbook path from issue title or labels
            RUNBOOK_PATH="runbooks/service-x/runbook.yaml"
            echo "runbook_path=$RUNBOOK_PATH" >> $GITHUB_OUTPUT
          else
            echo "Could not parse annotation command"
            exit 1
          fi
      
      - name: Update runbook with annotation
        run: |
          python runbooks/service-x/scripts/annotate_incident.py \
            --runbook "${{ steps.parse.outputs.runbook_path }}" \
            --incident "${{ steps.parse.outputs.incident_id }}" \
            --cause "${{ steps.parse.outputs.cause }}" \
            --fix "${{ steps.parse.outputs.fix }}"
      
      - name: Create pull request
        run: |
          git config --global user.name 'Runbook Bot'
          git config --global user.email 'bot@example.com'

          BRANCH_NAME="annotation-${{ steps.parse.outputs.incident_id }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          git add "${{ steps.parse.outputs.runbook_path }}"
          git commit -m "Add annotation for ${{ steps.parse.outputs.incident_id }} [skip ci]"
          git push origin "$BRANCH_NAME"

          gh pr create \
            --title "Add annotation for ${{ steps.parse.outputs.incident_id }}" \
            --body "Automatically added annotation from issue comment.\n\nIncident: ${{ steps.parse.outputs.incident_id }}\nCause: ${{ steps.parse.outputs.cause }}\nFix: ${{ steps.parse.outputs.fix }}" \
            --head "$BRANCH_NAME" \
            --base master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  process-annotation-workflow:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Update runbook with annotation
        env:
          RUNBOOK_PATH: ${{ inputs.runbook_path }}
          INCIDENT_ID: ${{ inputs.incident_id }}
          CAUSE: ${{ inputs.cause }}
          FIX: ${{ inputs.fix }}
        run: |
          python runbooks/service-x/scripts/annotate_incident.py \
            --runbook "$RUNBOOK_PATH" \
            --incident "$INCIDENT_ID" \
            --cause "$CAUSE" \
            --fix "$FIX"

      - name: Create pull request
        run: |
          git config --global user.name 'Runbook Bot'
          git config --global user.email 'bot@example.com'

          BRANCH_NAME="annotation-${{ inputs.incident_id }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          git add "${{ inputs.runbook_path }}"
          git commit -m "Add annotation for ${{ inputs.incident_id }} [skip ci]"
          git push origin "$BRANCH_NAME"

          gh pr create \
            --title "Add annotation for ${{ inputs.incident_id }}" \
            --body "Automatically added annotation from workflow dispatch.\n\nIncident: ${{ inputs.incident_id }}\nCause: ${{ inputs.cause }}\nFix: ${{ inputs.fix }}" \
            --head "$BRANCH_NAME" \
            --base master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}