name: Suggest Runbook Updates

on:
  schedule:
    - cron: '0 0 * * 1'  # Every Monday at midnight
  workflow_dispatch:  # Allow manual trigger

jobs:
  suggest-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Run suggestion engine
        run: |
          python runbooks/service-x/scripts/suggest_updates.py --runbook runbooks/service-x/runbook.yaml --export suggestions.json
      
      - name: Create or update PR if needed
        run: |
          # Check if there are any suggestions
          if [ -s suggestions.json ] && [ "$(jq length suggestions.json)" -gt 0 ]; then
            echo "Found suggestions, creating PR..."
            
            # Create a new branch
            git config --global user.name 'Runbook Bot'
            git config --global user.email 'bot@example.com'
            BRANCH_NAME="runbook-suggestions-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH_NAME"
            
            # Create a PR description from suggestions
            cat > pr-description.md << 'EOF'
          ## Runbook Update Suggestions
          
          This PR was automatically generated based on analysis of past incidents.
          
          ### Suggestions:
          EOF
          
            # Add each suggestion to the PR description
            jq -r '.[] | "- **\(.type)**: \(.item) - \(.reason)"' suggestions.json >> pr-description.md
            
            # Add more details about the changes
            cat >> pr-description.md << 'EOF'
          
          ### Files Changed:
          - Updated runbook with new insights from incident analysis
          
          ### Next Steps:
          - Review the suggested changes
          - Verify the proposed steps are appropriate
          - Update the runbook as needed
          
          *This PR was automatically generated by the Living Runbooks system.*
          EOF
            
            # Create a simple update to the runbook to demonstrate the PR
            # In a real scenario, this would make actual changes to the runbook
            if [ -f "runbooks/service-x/runbook.yaml" ]; then
              # Add a comment to the runbook to trigger a change
              sed -i "1s/^/# Auto-update suggestions added on $(date)\n/" runbooks/service-x/runbook.yaml
              git add runbooks/service-x/runbook.yaml
            fi
            
            # Commit changes
            git add .
            git commit -m "Auto-suggest runbook updates based on incident analysis [skip ci]"
            
            # Push the branch
            git push origin "$BRANCH_NAME"
            
            # Create a pull request using GitHub CLI
            gh pr create \
              --title "Auto-update runbook suggestions" \
              --body-file pr-description.md \
              --head "$BRANCH_NAME" \
              --base main
          else
            echo "No suggestions found, skipping PR creation"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}